#整体架构
###输入接口
+ 仅支持输入带时间戳的图像信息，以及带时间戳的IMU信息，且输入格式由**ImageMessage**和**IMUMessage**决定。

注：如果是裸应用程序环境，则需要额外编写数据集文件读取函数，在实例化我的VIO之后，以指定格式调用两个输入函数，输入图像数据和IMU数据。

###输出接口
+ 可获取最新的位置、姿态、速度估计结果，分别为t_wb、q_wb、v_wb，即以IMU定义的机体坐标系基于世界坐标系的位姿和速度作为输出。


---
#环境依赖
+ 依赖于Eigen3、OpenCV3、Pangolin、TBB。
+ 所有程序均采用C++编码。


---
#源码文件结构
###/interface
#####/interface.cpp

+ 主体头文件estimator.hpp的分体源文件。定义我的VIO的对外输入输出接口函数，包括输入图像帧数据、IMU数据，输出最新状态估计结果等。
+ 调用输入接口之后，图像帧数据和IMU数据将被简单封装处理，并存放到**VIOMono**实例的list容器定义的buff中。
+ 定义对外公开的系统初始化方法，调用及其完成**VIOMono**的初始化。
+ 定义对外公开的RunOnce()方法。调用一次，则从buff缓冲区中提取一个新数据进行处理。把IMU数据载入到临时IMUPreintegration类中，更新预积分结果。对图像数据使用FeatureTracker，更新LandmarkManager和FrameManager。进一步的，如果当前窗口内帧的数量达到要求（即达到windowSize），则根据求解器状态选择是初始化还是求解问题。

#####/message_format.hpp
+ 对输入所要求的图像帧和IMU帧的数据格式给出明确定义，声明为**ImageMessage**类和**IMUMessage**类，固定采用float单精度。



---
###/camera_model
#####/camera_base.hpp
+ 固定采用float单精度，定义**CameraBase**基类。
+ 在基类中声明畸变校正、归一化平面投影等方法，对于部分依赖于相机模型的方法，定义为virtual方法，在子类中进行override。
+ 完成以map映射的方法实现反畸变变换的方法，但畸变变换过程依赖于相机模型。

#####/pinhole_camera.hpp_cpp
+ 继承**CameraBase**基类，定义针孔相机模型，完善依赖于相机模型的相关方法。

#####/fisheye_camera.hpp_cpp
+ 继承**CameraBase**基类，定义鱼眼相机模型，完善依赖于相机模型的相关方法。



---
###/config_parameters
#####/config.hpp_cpp
+ 从config.yaml文件（如/config/euroc.yaml）中读取配置参数信息并存储在成员变量中。
+ 定义**Config**类，保存包括相机模型参数、IMU噪声参数、滑动窗口大小、特征点追踪器参数、初始化参数、后端优化参数等所有可配置参数。
+ 在**VIOMono**类中作为成员对象this->config存在。
+ 定义读取yaml类型文件的方法，以及将当前配置参数保存为yaml类型文件的方法。



---
###/measurement
#####/feature_tracker.hpp_cpp
+ 前端特征点追踪管理器，采用LK光流法追踪特征点，Harris角点检测新特征点。
+ 对外提供数据输入接口Track(image, timestamp)，在输入的图像中追踪特征点，并在内部保存上一帧的特征点追踪结果。
+ 对外提供数据输出接口，采用public成员变量的方法进行结果共享式输出。输出最新的特征点追踪结果，包括特征点ID号、特征点在最新一帧的像素坐标与归一化平面坐标，以及最新一帧图像的编号。
+ 对外提供图像编号偏移接口。当边缘化次新帧的时候，最新帧的编号需要减1，因此需要在编号确定的源头做出调整。
+ 特征点追踪器将会在追踪过程中，为每一个新的图像帧和新的特征点指定其ID。

#####/landmark_manager.hpp_cpp
+ 特征点管理器，固定采用float精度。
+ 定义**Observe**类，描述某一个特征点在某一帧图像中的观测。
+ 定义**Landmark**类，描述某一个特征点，通过vector容器以及this-firstObserveID来管理与此特征点有关的观测帧与观测。
+ 定义**LandmarkManager**类，以unordered_map容器的方式保存所有特征点，定义对应feature_tracker输出的输入接口（增加旧特征点的观测信息，增加新特征点），定义删除最旧一帧时对应特征点信息的修改接口（去除对应观测，调整特征点首帧观测ID，更新或重置特征点的逆深度），定义删除次新一帧时对应特征点信息的修改接口（去除对应观测）。
+ LandmarkManager作为**VIOMono**实例的一个成员对象存在。

#####/imu_preintegration.hpp_cpp
+ 预积分块的定义与相关方法实现。
+ 定义**IMUPreintegration**类，以list容器或者reserve之后的vector容器存储<时间戳、加速度、角速度>数据，以float单精度保存两个偏差项bias_a、bias_g，三个预积分项p、v、q，以及协方差矩阵covariance和雅可比矩阵jacobian。
+ **IMUPreintegration**类的构造必须指定bias_a和bias_g，因此在estimator.hpp本体中定义current_bias_a和current_bias_g来表示偏差值的最新估计结果。
+ 定义中值积分方法，读取存储buff中的数据，完成预积分值、协方差和雅可比的计算。
+ 定义快速更新方法，输入偏差值的改变量，基于雅可比矩阵jacobian对预积分值进行近似调整。
+ 以静态成员变量的形式定义噪声模型参数，即高斯白噪声和随机游走噪声。

#####/frame_manager.hpp_cpp
+ 帧管理器，固定采用float单精度。
+ 定义**Frame**类，存储某一帧相机的位姿q_wc、t_wc、v_wc，采用vector<shared_ptr>存储此帧观测到的特征点Landmark，存储原始图像信息。
+ 在**Frame**类中，定义提取当前帧与另一个指定帧的共视特征点的方法，并基于这个方法，进一步定义判断当前帧与另一帧的平均视差的方法（当两帧之间不存在共视特征点时，平均视差返回-1，用于判断）。
+ 定义**CombinedFrame**类，继承Frame类，增加一个指向IMUPreintegration实例的智能指针，并增加某一帧相机对应的IMU预积分块的位姿q_wb、t_wb、v_wb。
+ 定义**FrameManager**类，以list容器保存所有CombinedFrame实例。定义对应feature_tracker输出的输入接口（增加新的图像帧，同时需要绑定一个IMU预积分块）。
+ 在**FrameManager**类中，定义删除最旧一帧时关键帧信息的修改接口（直接删除最旧的CombinedFrame实例，并输出这个CombinedFrame对应的Image的ID，方便给feature_manager删除对应的特征点观测），定义删除次新一帧时关键帧信息的修改接口（将待删除的N-1帧的IMU预积分的buff累加到N-2帧上，删除N-1的CombinedFrame，让第N个CombinedFrame替换到N-1的位置，调整其ID，并调用feature_tracker的接口来调整其图像帧的自动计数器）。**在后续开发中，这两个函数被合并为删除指定一帧关键帧信息的修改接口。**



---
###/estimator
#####/estimator.hpp_cpp
+ 定义我的VIO的主体**VIOMono**类，管理整个vio-mono系统的运行。
+ 声明对外接口函数，包括输入图像、输入IMU、系统初始化、单步运行、状态数据输出等。
+ 以float单精度存储最新的估计状态current_q_wb、current_t_wb、current_v_wb等等，这些变量可通过在interface.cpp中定义的成员函数向外输出。
+ 以list形式定义Image数据和IMU数据的缓冲buff区，每一个数据都通过std::pair绑定一个时间戳。定义数据块提取方法，每次从缓冲buff区中提取出一帧Image数据和绑定的一串IMU数据。
+ 定义对内的数据提取方法，按照时间戳顺序输出图像帧数据和IMU数据，提供两者延迟补偿功能，并在图像帧数据输出之前和输出之后，采用线性差值方法输出相同时间戳的IMU数据（图像输出前后各一次）。
+ 定义对捆绑的图像与IMU数据的预处理方法，完成追踪图像特征、计算IMU预积分、设定初值、构造实例交付给对应管理器的过程。
+ 以智能指针的方式保存成员对象**Config**，用于存储所有可配置参数。
+ 以智能指针的方式保存成员对象**FeatureTracker**，用于追踪新Image的特征点。
+ 以智能指针的方式保存成员对象**LandmarkManager**，用于管理所有特征点。
+ 以智能指针的方式保存成员对象**FrameManager**，用于管理所有帧。
+ 将各个子模块的初始化和利用Config来配制的过程都陈列为UpdateConfigParams_xxx()成员方法，在系统初始化过程中依次调用。
+ 声明并定义移除最旧观测和次新观测时，整个系统的各个模块应当做出怎样的调整的成员方法。
+ 移除最旧观测时，移除滑动窗口内最旧的相机和IMU信息，移除特征点在最旧帧中的观测信息，滑动窗口内的帧ID保持递进。
+ 移除次新观测时，将滑动窗口内次新帧的IMU数据累加到次次新帧的IMU数据上，移除次新帧及其IMU存储体，调整最新帧的ID为被移除的次新帧的ID。移除特征点在次新帧中的观测，并根据实际情况调整其观测索引ID号。调整featureTracker的帧计数器，使其之后的ID输出符合滑动窗口内的递进关系。
+ 声明后端求解器初始化部分成员方法。
+ 声明后端求解器部分成员方法。
+ 定义枚举类型**Status**，标注当前求解器的状态是待初始化，还是运行中，还是采取哪一种边缘化策略。
+ 保存最新的先验信息prior_H、prior_b、prior_JTinv、prior_r。


#####/estimator_support.cpp
+ 对VIOMono类中的相关成员方法进行定义。
+ 定义方法：给定一个关键帧，利用其观测到的已经三角化的特征点，采用基于RANSAC的PnP方法估计其位姿。
+ 定义方法：给定一个特征点和两帧观测，对其进行三角测量。
+ 定义方法：给定两个关键帧，利用两帧已知的位姿，三角测量共视的特征点。
+ 定义方法：给定两个关键帧，利用两帧的共视特征点的归一化平面观测信息，估计两帧之间的相对位姿。

#####/estimator_visualize.cpp
+ 对VIOMono类中的相关成员方法进行定义。
+ 将滑动窗口内的关键帧坐标和轨迹、IMU坐标和轨迹、特征点位置进行可视化。但这一方法是阻塞进行，因此如果需要观测动态过程，则需要将其单独放到一个线程中。

---
###/estimator/support
#####/epipolar_geometry.hpp_cpp
+ 基于对极约束的三角测量、相对位姿估计算法。
#####/perspective_n_points.hpp_cpp
+ 基于 PnP 的最小化重投影误差算法。


---
###/estimator/initialize
#####/initialize.cpp
+ 对VIOMono类中的初始化相关成员方法进行定义。
+ 求解器初始化可主要分为三个部分。第一部分为纯视觉三维重构，第二部分为视觉与惯性的联合，第三部分为通用方法（如对极约束、三角测量，PnP最小化重投影误差等）。但通用部分不仅仅支持初始化，因此放在/estimator/support路径下。
  
#####/initialize_visual_only.cpp
+ 纯视觉三维重构部分。主要基于对极约束相对位姿估计、三角测量和PnP算法，估计相机和特征点的位姿初值。之后基于此初值，利用图优化求解器优化相机和特征点构成的BA问题。
+ 在利用图优化求解器优化BA问题这部分，分别就逆深度和世界坐标系位置两种描述特征点的方式，定义了两种函数。通过测试，均可完成BA问题初始化工作，且可视化结果符合实际。

#####/initialize_align.cpp
+ 视觉与IMU联合初始化部分，包括估计角速度偏差、加载IMU和相机的相对位姿、以3自由度描述粗略估计重力加速度和相机尺度以及每帧速度、以2自由度优化估计重力加速度。


---
###/estimator/optimize
#####/optimize.cpp
+ 对VIOMono类中的紧耦合优化相关成员方法进行定义。
+ 定义初值估计方法。基于IMU预积分，对滑动窗口内最新一帧的位姿进行预估。利用所有相机位姿对所有未三角化的特征点进行三角化。利用特征点的世界坐标系中的位置，更新每一个特征点在首帧观测中的逆深度。
+ 定义紧耦合后端优化方法。构造优化问题，传入相机外参节点、相机节点、速度偏差节点、特征点逆深度节点，传入先验残差、相机残差、IMU残差，配置参数后进行迭代优化。优化完成后，提取更新后的先验信息，保存于VIOMono类中，同时更新滑动窗口内所有参数。

#####/marginalize.cpp
+ 对VIOMono类中的边缘化相关成员方法进行定义。
+ 定义判断边缘化策略的方法。根据次新帧与次次新帧之间的平均视差和共视特征点数，决定边缘化最旧帧还是边缘化次新帧。
+ 定义边缘化最旧帧的方法。构造优化问题，传入相机外参节点、所有相机节点、所有速度偏差节点，传入首次观测为最旧帧的特征点逆深度节点，传入次旧帧与最旧帧之间的IMU残差、与加入的特征点有关的相机残差，以及从VIOMono类中提取的先验残差，配置参数后执行边缘化操作。边缘化完成后，提取构造所得先验信息，保存于VIOMono类中。
+ 定义边缘化次新帧的方法。构造优化问题，传入相机外参节点、所有相机节点、所有速度偏差节点，传入从VIOMono类中提取的先验残差，配置参数后执行边缘化操作。边缘化完成后，提取构造所得先验信息，保存于VIOMono类中。
+ 边缘化之后，对于滑动窗口的数据管理的操作，在estimator.cpp中已经定义。

---
###/ba_solver
#####/utility.hpp
+ 基于模板类，构建一些通用类型和通用方法。
+ 通用方法包括计算反对称矩阵、计算平移和旋转误差。

#####/vertex.hpp
+ 定义描述一个节点的基类。
+ 图优化器的节点就是待优化参数，提供参数的存储、更新、备份、固定等功能。

#####/edge.hpp
+ 定义描述一个约束边的基类。
+ 图优化器的边就是节点之间的约束关系，一个边可以建立起一个或者多个节点之间的约束，每一个边都对应一个观测误差。
+ 这里的边也被称之为Factor。

#####/kernel_function.hpp
+ 定义鲁棒核函数的基类。
+ 定义朴素核函数（就是不加核函数）、Huber核函数的实现，计算核函数的值以及一阶导数，作用在edge中计算的residual和jacobians上。
+ 核函数的作用过程，需要在继承了edge的子类中重写的ComputeResidual()和ComputeJacobians()方法中自行实现。

#####/timer.hpp
+ 定义计时器类，统计求解问题消耗的时间。

#####/problem.hpp
+ 定义管理待求解优化问题的类。
+ 提供基于LM算法和Dogleg算法的数值优化求解算法，以及PCG、LLT、LDLT、QR四种线性方程求解器。基于英特尔TBB库实现了并行加速。